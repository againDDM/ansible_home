---

services:

  db:
    container_name: "{{ postgres_container_name }}"
    image: "postgres:{{ postgres_version }}"
    restart: unless-stopped
    tty: true
    mem_limit: "{{ postgres_memory_limit_mb }}M"
    mem_reservation: "{{ postgres_memory_limit_mb}}M"
    shm_size: "{{ postgres_memory_limit_mb // 4 }}M"
    volumes:
      - "{{ pgdata_host_path }}:{{ pgdata_container_path }}:rw"
    environment:
      POSTGRES_DB: "{{ postgres_db }}"
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
      PGDATA: "{{ pgdata_container_path }}"
    logging: &logging
      driver: "json-file"
      options:
        max-size: 10m
        max-file: "3"

  redis:
    container_name: "{{ redis_container_name }}"
    image: "redis:{{ redis_version }}"
    restart: unless-stopped
    tty: true
    mem_limit: "{{ redis_memory_limit_mb }}M"
    mem_reservation: "{{ redis_memory_limit_mb}}M"
    command: ["redis-server", "--requirepass", "{{ redis_password }}"]
    logging:
      <<: *logging

  app:
    container_name: "{{ application_container_name }}"
    image: "nextcloud:{{ nextcloud_version }}"
    restart: unless-stopped
    tty: true
    mem_limit: "{{ nextcloud_memory_limit_mb }}M"
    volumes:
      - "{{ nextcloud_data_host_path }}:/var/www/html:rw"
    environment:
      POSTGRES_HOST: "{{ postgres_host }}"
      POSTGRES_DB: "{{ postgres_db }}"
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
      REDIS_HOST: "{{ redis_host }}"
      REDIS_HOST_PORT: "6379"
      REDIS_HOST_PASSWORD: "{{ redis_password }}"
    ports:
      - "{{ nextcloud_external_port }}:80"
    links:
      - "db:{{ postgres_host }}"
      - "redis:{{ redis_host }}"
    depends_on:
      - "db"
      - "redis"
    logging:
      <<: *logging
