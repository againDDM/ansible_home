
- name: Ensure client config dir exists
  file:
    path: "{{ proxy_masked_client_dir }}"
    state: directory
    mode: "0755"

- name: Manage masked clients UUID and WS paths
  masked_clients_state:
    clients: "{{ proxy_masked_clients }}"
    force: false
  register: masked_result

- name: Update proxy_masked_clients fact
  set_fact:
    proxy_masked_clients: "{{ masked_result.clients }}"

- name: Generate client configs for each client
  template:
    src: client.json.j2
    dest: "{{ proxy_masked_client_dir }}/{{ item.key }}.json"
    mode: "0644"
  loop: "{{ proxy_masked_clients | dict2items }}"
  loop_control:
    loop_var: item
  vars:
    client_uuid: "{{ item.value.uuid }}"
  no_log: true

- name: Generate sing-box server config with all clients
  template:
    src: singbox_multi_clients.json.j2
    dest: /etc/sing-box/config.json
  notify:
    - restart sing-box
